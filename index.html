<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hill AFB Visit Tracker (Cloud Sync) — v16</title>

  <!-- PWA / icons -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="VisitTracker" />
  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="apple-touch-icon" href="icons/icon-192.png" />
  <meta name="theme-color" content="#1f6feb" />

  <!-- Security: auto-upgrade any http:// subresources to https:// -->
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests" />

  <style>
    :root { --bg:#f7f7fb; --card:#fff; --text:#222; --muted:#666; --border:#e5e5ef; --green:#26a269; --yellow:#e5a50a; --red:#c01c28; --blue:#1f6feb; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";background:var(--bg);color:var(--text)}
    header{position:sticky;top:0;z-index:5;background:linear-gradient(180deg,var(--blue),#3a7cf0);color:#fff;border-bottom:1px solid var(--border);padding:6px 10px;display:flex;flex-direction:column;gap:6px}
    .toprow{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    header h1{font-size:16px;margin:0}
    .tagline{color:#e6eeff;font-size:11px}
    @media (max-width:520px){ .tagline{display:none} }
    .right{margin-left:auto}
    .row{display:flex;align-items:center;gap:6px;flex-wrap:wrap}
    .chip{background:transparent;color:#fff;border:1px solid rgba(255,255,255,.45);border-radius:999px;padding:5px 10px;font-size:14px;cursor:pointer}
    .chip.strong{background:#1f6feb;border-color:#1f6feb}
    .authbar input{border-color:rgba(255,255,255,.5);background:rgba(255,255,255,.1);color:#fff;border-radius:999px;padding:6px 10px;font-size:14px}
    .authbar input::placeholder{color:#eef}
    .whoami{font-size:12px;color:#e6eeff;margin-right:2px}
    @media (max-width:430px){ .whoami{display:none} }
    .hidden{display:none!important}
    .navchips{display:flex;gap:8px;flex-wrap:wrap}
    main{padding:14px;max-width:1100px;margin:0 auto}
    .toolbar{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:10px;position:relative}
    button,select,input,textarea{font:inherit;padding:9px 12px;border-radius:10px;border:1px solid var(--border);background:#fff;color:#222}
    .search-wrap{position:relative;display:flex;align-items:center;flex:0 1 220px;width:100%;transition:flex-basis .18s ease,width .18s ease}
    .search-wrap input{width:100%;padding-right:34px;transition:box-shadow .18s ease,border-color .18s ease}
    .toolbar.search-expanded .search-wrap{flex:1 1 100%;z-index:3;}
    .toolbar.search-expanded .search-wrap input{border-color:var(--blue);box-shadow:0 8px 24px rgba(31,111,235,.18);background:#fff}
    .toolbar.search-expanded #filter-status{opacity:0;pointer-events:none;visibility:hidden;position:absolute}
    .clear-input{position:absolute;right:6px;display:flex;align-items:center;justify-content:center;width:26px;height:26px;border-radius:50%;border:none;background:rgba(0,0,0,0.08);color:var(--muted);font-size:18px;line-height:1;cursor:pointer;transition:background 0.15s ease,color 0.15s ease,outline 0.15s ease;}
    .clear-input:hover,.clear-input:focus{background:rgba(0,0,0,0.15);color:var(--text);outline:2px solid var(--blue);outline-offset:2px;}
    #contact-form-placeholder{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:12px;padding:24px;text-align:center;min-height:220px;}
    #contact-form-placeholder h3{margin:4px 0 0 0;font-size:18px;}
    #contact-form-placeholder p{margin:0;color:var(--muted);font-size:13px;}
    .compact-form{padding:12px;}
    .compact-form .grid{gap:8px;}
    .compact-form .field label{margin:0 0 3px 2px;}
    .compact-form .field input,.compact-form .field select{padding:8px 10px;}
    .compact-form .chip{background:#fff;color:var(--blue);border-color:var(--border);}
    .compact-form .chip.btn-cancel-contact{color:var(--muted);}
    .form-header{display:flex;align-items:center;justify-content:space-between;gap:8px;margin:0 0 10px 0;flex-wrap:wrap;}
    .form-header h3{margin:0;}
    .field input,.field select,.field textarea{width:100%}
    label{display:block;margin:0 0 5px 2px;font-weight:600}
    .grid{display:grid;grid-template-columns:1fr;gap:10px}
    .col-4,.col-6,.col-8,.col-12{grid-column:span 1}
    @media (min-width:900px){
      .grid{grid-template-columns:repeat(12,minmax(0,1fr))}
      .col-4{grid-column:span 4}.col-6{grid-column:span 6}.col-8{grid-column:span 8}.col-12{grid-column:span 12}
    }
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:10px;box-shadow:0 1px 2px rgba(0,0,0,.03)}
    .card h3{margin:0 0 4px 0;font-size:16px}
    .muted{color:var(--muted);font-size:12px}
    .card.red{border-left:6px solid var(--red)}
    .card.yellow{border-left:6px solid var(--yellow)}
    .card.green{border-left:6px solid var(--green)}
    .contact-row{display:flex;gap:10px;align-items:flex-start;justify-content:space-between;flex-wrap:wrap}
    .contact-actions{display:flex;gap:6px;flex-wrap:wrap}
    .pill{font-size:11px;padding:2px 8px;border-radius:999px;border:1px solid var(--border);background:#fff;display:inline-block}
    .pill.red{border-color:var(--red);color:var(--red)} .pill.yellow{border-color:var(--yellow);color:var(--yellow)} .pill.green{border-color:var(--green);color:var(--green)}
    .meta-line{display:flex;gap:6px;align-items:center;flex-wrap:nowrap;overflow:auto;scrollbar-width:none}
    .meta-line::-webkit-scrollbar{display:none}
    .btn-ghost{background:#fff;border:1px solid var(--border);border-radius:999px;padding:7px 14px;cursor:pointer}
    #today-list,#visit-list,#contact-list{display:grid;grid-template-columns:1fr;gap:10px}
    @media (min-width:600px){ #today-list,#contact-list{grid-template-columns:1fr 1fr} }
    @media (min-width:1100px){ #today-list,#contact-list{grid-template-columns:1fr 1fr 1fr} }
    .footer{margin-top:16px;color:var(--muted);font-size:12px}
  </style>

  <!-- CSV parser -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <!-- Firebase (compat SDK to maximize compatibility across environments) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
</head>
<body>
  <header>
    <div class="toprow">
      <h1>Hill AFB Visit Tracker (Cloud Sync) — v16</h1>
      <span class="tagline">Cloud sync • Offline • Local cache</span>

      <!-- Signed OUT -->
      <div class="right row authbar" id="authbar-unauthed">
        <input id="auth-email" placeholder="email" autocapitalize="off" autocomplete="username" />
        <input id="auth-pass" placeholder="password" type="password" autocomplete="current-password" />
        <button id="btn-signin" class="chip">Sign in</button>
        <button id="btn-signup" class="chip">Create</button>
      </div>

      <!-- Signed IN -->
      <div class="right row authbar hidden" id="authbar-authed">
        <span id="whoami" class="whoami"></span>
        <button id="btn-export" class="chip">Export</button>
        <button id="btn-import-json" class="chip">Import JSON</button>
        <button id="btn-import-csv" class="chip">Import CSV</button>
        <input id="import-json-file" type="file" accept="application/json" class="hidden" />
        <input id="import-csv-file" type="file" accept=".csv,text/csv" class="hidden" />
        <button id="btn-signout" class="chip strong">Sign out</button>
      </div>
    </div>

    <div class="navchips" id="nav-controls">
      <button id="btn-show-today" class="chip">Today</button>
      <button id="btn-show-contacts" class="chip">Contacts</button>
      <button id="btn-show-log" class="chip">Log Visit</button>
    </div>
  </header>

  <!-- Offline banner -->
  <div id="offline-banner" style="display:none;padding:8px 12px;background:#fff3cd;border:1px solid #ffeeba;color:#856404;margin:10px;border-radius:8px;">
    You’re offline. You can keep working with cached data if you were already signed in. Sign-in requires internet.
  </div>

  <main>
    <section id="view-today">
      <div class="toolbar">
        <div class="search-wrap" style="flex:1">
          <input id="search" placeholder="Search name/org/location…" autocomplete="off" />
          <button type="button" id="btn-clear-search" class="clear-input hidden" aria-label="Clear search">&times;</button>
        </div>
        <label for="filter-status" class="hidden">Status filter</label>
        <select id="filter-status">
          <option value="all">All statuses</option>
          <option value="red">Past due</option>
          <option value="yellow">Due this week</option>
          <option value="green">Not due</option>
        </select>
        <button id="btn-add-quick" class="chip strong">+ Quick add</button>
      </div>
      <div id="today-list"></div>
      <div class="footer">Status rules: <span class="pill red">Past due</span> ≤ today • <span class="pill yellow">Due this week</span> within 7 days • <span class="pill green">Not due</span> &gt; 7 days.</div>
    </section>

    <section id="view-contacts" class="hidden">
      <div class="grid">
        <div class="col-6" id="contact-form-column">
          <div id="contact-form-placeholder" class="card">
            <h3>Add Contact</h3>
            <p>Build your directory one contact at a time.</p>
            <button type="button" id="btn-show-contact-form" class="chip strong">+ Add contact</button>
          </div>
          <div class="card compact-form hidden" id="contact-form-card">
            <div class="form-header">
              <h3 id="form-title">Add Contact</h3>
            </div>
            <form id="contact-form" onsubmit="event.preventDefault();return false;">
              <input type="hidden" id="contact-id" />
              <div class="grid">
                <div class="col-6 field"><label for="name">Name</label><input id="name" required autocomplete="name" /></div>
                <div class="col-6 field"><label for="org">Org</label><input id="org" autocomplete="organization" /></div>
                <div class="col-12 field"><label for="location">Location</label><input id="location" autocomplete="address-line1" /></div>
                <div class="col-6 field"><label for="frequency">Frequency</label>
                  <select id="frequency">
                    <option>Weekly</option><option>Biweekly</option><option selected>Monthly</option><option>Quarterly</option><option>Custom</option>
                  </select>
                </div>
                <div class="col-6 field"><label for="freqDays">Frequency (days)</label><input id="freqDays" type="number" min="1" value="30" /></div>
                <div class="col-6 field"><label for="lastVisit">Last Visit</label><input id="lastVisit" type="date" /></div>
                <div class="col-6 field"><label for="active">Active</label>
                  <select id="active"><option value="true" selected>Yes</option><option value="false">No</option></select>
                </div>
                <div class="col-12 row" style="justify-content:flex-start">
                  <button class="chip strong" type="submit" id="btn-save-contact">Save</button>
                  <button type="button" class="chip btn-cancel-contact">Cancel</button>
                  <button type="button" id="btn-reset" class="chip">Reset</button>
                  <span class="muted" style="margin-left:auto">Tip: set Frequency to Custom for exact days.</span>
                </div>
              </div>
            </form>
          </div>
        </div>
        <div class="col-6">
          <div class="toolbar">
            <div class="search-wrap" style="flex:1">
              <input id="contact-search" placeholder="Search contacts…" autocomplete="off" />
              <button type="button" id="btn-clear-contact-search" class="clear-input hidden" aria-label="Clear contact search">&times;</button>
            </div>
            <button type="button" id="btn-toggle-archived" class="chip">Show archived</button>
          </div>
          <div id="contact-list"></div>
        </div>
      </div>
    </section>

    <section id="view-log" class="hidden">
      <div class="grid">
        <div class="col-4 card">
          <h3>Log Visit</h3>
          <form id="visit-form" onsubmit="event.preventDefault();return false;">
            <div class="field"><label for="visit-contact">Contact</label><select id="visit-contact" required></select></div>
            <div class="grid">
              <div class="col-6 field"><label for="visit-date">Visit Date</label><input id="visit-date" type="datetime-local" /></div>
              <div class="col-6 field"><label for="visit-outcome">Outcome</label>
                <select id="visit-outcome">
                  <option>Discovery</option><option>Follow-up</option><option>Quote Sent</option>
                  <option>Closed Won</option><option>Closed Lost</option><option>Other</option>
                </select>
              </div>
              <div class="col-12 field"><label for="visit-notes">Notes</label><textarea id="visit-notes" rows="4"></textarea></div>
              <div class="col-12 field"><label for="visit-next">Next Steps</label><input id="visit-next" /></div>
              <div class="col-12 field"><label for="visit-createdBy">Created By</label><input id="visit-createdBy" placeholder="GAR name or email" /></div>
            </div>
            <div class="row" style="margin-top:8px">
              <button class="chip strong" type="submit">Save Visit</button>
              <button type="button" id="btn-quick-today" class="chip">Mark as seen now</button>
            </div>
          </form>
        </div>
        <div class="col-8">
          <div class="toolbar"><input id="visit-search" placeholder="Search visits…" style="flex:1" autocomplete="off" /></div>
          <div id="visit-list"></div>
        </div>
      </div>
    </section>

    <div class="footer">
      Sign in (top-right) to enable sync across devices. Works offline; changes sync when back online. Export/Import still available for manual backup.
    </div>
  </main>

  <!-- Register the service worker (cache-bust with v16) -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function() {
        navigator.serviceWorker.register('sw.js?v=16');
      });
    }
  </script>

  <!-- Warm CDN cache once (so Firebase SDK & PapaParse work when offline) -->
  <script>
    async function warmCdnOnce(){
      if (!navigator.onLine) return;
      try {
        await Promise.allSettled([
          fetch('https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js', { cache: 'reload', mode: 'no-cors' }),
          fetch('https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js', { cache: 'reload', mode: 'no-cors' }),
          fetch('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js', { cache: 'reload', mode: 'no-cors' }),
          fetch('https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js', { cache: 'reload', mode: 'no-cors' }),
        ]);
      } catch (_) {}
    }
    window.addEventListener('load', warmCdnOnce);
  </script>

  <!-- App code (Firebase compat API) -->
  <script>
    // ----- Firebase config (keep your values)
    const firebaseConfig = {
      apiKey: "AIzaSyAoVOV9GPu6n4M2BVFlOSnXwEUcASjL9Dk",
      authDomain: "hill-afb-tracker-cloud.firebaseapp.com",
      projectId: "hill-afb-tracker-cloud",
      storageBucket: "hill-afb-tracker-cloud.firebasestorage.app",
      messagingSenderId: "554533323322",
      appId: "1:554533323322:web:ba751bda081e9d5d006b03"
    };

    // ----- Init Firebase (compat)
    const app = firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    // Enable offline persistence (ignore if already enabled on this device)
    db.enablePersistence().catch(()=>{});

    // ----- Small helpers
    const $ = (sel) => document.querySelector(sel);
    let user = null;
    const defaultDaysMap = { Weekly:7, Biweekly:14, Monthly:30, Quarterly:90 };
    let currentView = "view-today";
    let contactFormOrigin = "view-contacts";
    let showArchivedContacts = false;

    function colPath(store){ return "users/" + (user ? user.uid : "NOUSER") + "/" + store; }
    function fmtDate(date){ if(!date) return ""; const d=new Date(date); return d.toLocaleDateString()+" "+d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}); }
    function fmtDateOnly(date){ if(!date) return ""; const d=new Date(date); return d.toISOString().slice(0,10); }
    function dateAddDays(date, days){ const d=new Date(date||new Date()); d.setHours(0,0,0,0); d.setDate(d.getDate()+Number(days||0)); return d; }
    function defaultDays(freq, fallback){ if(fallback===undefined) fallback=30; return defaultDaysMap[freq]||fallback; }
    function computeStatus(contact){
      const last = contact.lastVisit ? new Date(contact.lastVisit) : null;
      const days = contact.freqDays || defaultDays(contact.frequency, 30);
      const nextDue = last ? dateAddDays(last, days) : new Date();
      const today = new Date(); today.setHours(0,0,0,0);
      const diff = Math.floor((nextDue - today)/(1000*60*60*24));
      let status = "red"; if(last){ status = diff<=0 ? "red" : (diff<=7 ? "yellow" : "green"); }
      return { nextDue, diffDays: diff, status };
    }
    function contactCardHTML(c, opts){
      opts = opts || {};
      const showArchive = !!opts.showArchive;
      const showUnarchive = !!opts.showUnarchive;
      const isArchived = !!opts.isArchived;
      const statusLabel = c.status === "red" ? "Past due" : (c.status === "yellow" ? "Due this week" : "Not due");
      return '<div class="card '+c.status+'">\
        <div class="contact-row">\
          <div style="flex:1 1 auto;min-width:220px">\
            <h3>'+ (c.name||"") +'</h3>\
            <div class="muted">'+ ((c.org||"") + (c.org&&c.location?" • ":"") + (c.location||"")) +'</div>\
            <div class="meta-line" style="margin-top:6px">\
              <span class="pill '+c.status+'">'+ statusLabel +'</span>\
              <span class="pill">Due: '+ fmtDateOnly(c.nextDue) +'</span>\
              <span class="pill">Freq: '+ (c.frequency||"") + (c.frequency==="Custom"?" ("+c.freqDays+"d)":"") +'</span>' +
              (isArchived ? ' <span class="pill">Archived</span>' : '') +
            '</div>\
          </div>\
          <div class="contact-actions">\
            <button data-id="'+c.id+'" class="btn-ghost btn-log-now">Log</button>\
            <button data-id="'+c.id+'" class="btn-ghost btn-edit">Edit</button>' +
            (showArchive ? ' <button data-id="'+c.id+'" class="btn-ghost btn-archive">Archive</button>' : '') +
            (showUnarchive ? ' <button data-id="'+c.id+'" class="btn-ghost btn-unarchive">Unarchive</button>' : '') +
          '</div>\
        </div>\
      </div>';
    }

    // ----- Data access (compat)
    async function addItem(store, value){
      if (!user) throw new Error("Sign in first");
      const ref = await db.collection(colPath(store)).add(value);
      await db.collection(colPath(store)).doc(ref.id).set(Object.assign({}, value, { id: ref.id }), { merge:true });
      return ref.id;
    }
    async function putItem(store, value){
      if (!user) throw new Error("Sign in first");
      const id = value.id || (await addItem(store, value));
      if (!value.id) return id;
      await db.collection(colPath(store)).doc(id).set(value, { merge:true });
      return id;
    }
    async function getAll(store){
      if (!user) return [];
      const snap = await db.collection(colPath(store)).get();
      return snap.docs.map(d => { const v=d.data(); v.id=d.id; return v; });
    }
    async function getByKey(store, id){
      const docRef = await db.collection(colPath(store)).doc(id).get();
      return docRef.exists ? Object.assign({id: docRef.id}, docRef.data()) : null;
    }

    // ----- Renderers
    async function renderToday(){
      const q = ($("#search").value||"").toLowerCase().trim();
      const statusFilter = $("#filter-status").value;
      const contacts = (await getAll("contacts")).filter(c => c.active !== false);
      const enriched = contacts.map(c => Object.assign({}, c, computeStatus(c)))
        .filter(c => {
          const hay=(c.name+" "+(c.org||"")+" "+(c.location||"")).toLowerCase();
          return (!q || hay.includes(q)) && (statusFilter==="all" || c.status===statusFilter);
        })
        .sort((a,b)=>{
          const score = (s)=>s==="red"?3:s==="yellow"?2:1;
          const s = score(b.status)-score(a.status); if(s!==0) return s;
          const d = a.diffDays - b.diffDays; if(d!==0) return d;
          return (a.name||"").localeCompare(b.name||"");
        });

      const host=$("#today-list"); host.innerHTML="";
      enriched.forEach(c=>{
        const wrap=document.createElement("div");
        wrap.innerHTML = contactCardHTML(c, {showArchive:false});
        host.appendChild(wrap.firstChild);
      });

      host.querySelectorAll(".btn-edit").forEach(btn=>btn.addEventListener("click", async e=>{
        const id=e.currentTarget.getAttribute("data-id"); const c=await getByKey("contacts", id);
        const origin = currentView;
        showSection("view-contacts");
        populateContactForm(c, { origin });
        window.scrollTo({top:0, behavior:'smooth'});
      }));
      host.querySelectorAll(".btn-log-now").forEach(btn=>btn.addEventListener("click", async e=>{
        const id=e.currentTarget.getAttribute("data-id"); const c=await getByKey("contacts", id); await logVisitNow(c);
      }));
    }

    function showContactForm(opts){
      opts = opts || {};
      contactFormOrigin = (opts.origin !== undefined ? opts.origin : currentView) || "view-contacts";
      $("#contact-form-card")?.classList.remove("hidden");
      $("#contact-form-placeholder")?.classList.add("hidden");
    }

    function hideContactForm(opts){
      opts = opts || {};
      $("#contact-form-card")?.classList.add("hidden");
      $("#contact-form-placeholder")?.classList.remove("hidden");
      if (opts.reset !== false) clearContactForm();
      if (opts.restoreView && contactFormOrigin && contactFormOrigin !== currentView){
        showSection(contactFormOrigin);
      }
      contactFormOrigin = "view-contacts";
    }

    function populateContactForm(c, opts){
      opts = opts || {};
      showContactForm({ origin: opts.origin });
      $("#form-title").textContent = (c && c.id) ? "Edit Contact" : "Add Contact";
      $("#contact-id").value = (c && c.id) ? c.id : "";
      $("#name").value = c?.name || "";
      $("#org").value = c?.org || "";
      $("#location").value = c?.location || "";
      $("#frequency").value = c?.frequency || "Monthly";
      $("#freqDays").value = c?.freqDays || (defaultDaysMap[$("#frequency").value]||30);
      $("#lastVisit").value = c?.lastVisit ? fmtDateOnly(c.lastVisit) : "";
      $("#active").value = (c && c.active===false) ? "false" : "true";
      setTimeout(()=> $("#name")?.focus(), 0);
    }

    function clearContactForm(){
      const f=$("#contact-form"); f.reset();
      $("#form-title").textContent = "Add Contact";
      $("#contact-id").value = "";
      $("#frequency").value = "Monthly";
      $("#freqDays").value = 30;
      $("#active").value = "true";
    }

    function updateArchivedToggleUI(){
      const btn = $("#btn-toggle-archived");
      if (!btn) return;
      btn.textContent = showArchivedContacts ? "Hide archived" : "Show archived";
      btn.classList.toggle("strong", showArchivedContacts);
    }

    async function renderContactsList(){
      const raw = ($("#contact-search")?.value || "").toLowerCase().trim();
      const tokens = raw.split(/\s+/).filter(Boolean);

      const contacts = (await getAll("contacts"))
        .filter(c => showArchivedContacts ? true : c.active !== false)
        .sort((a,b)=>{
          const aIsArchived = a.active === false;
          const bIsArchived = b.active === false;
          if (aIsArchived !== bIsArchived) return aIsArchived ? 1 : -1;
          return (a.name||"").localeCompare(b.name||"");
        });

      const host = $("#contact-list"); host.innerHTML="";
      updateArchivedToggleUI();

      contacts
        .map(c => Object.assign({}, c, computeStatus(c)))
        .filter(c => {
          if (!tokens.length) return true;
          const hay = [c.name, c.org, c.location]
            .filter(Boolean).join(" ").toLowerCase();
          return tokens.every(t => hay.includes(t));
        })
        .forEach(c=>{
          const isArchived = c.active === false;
          const node=document.createElement("div");
          node.innerHTML=contactCardHTML(c, {
            showArchive: !isArchived,
            showUnarchive: showArchivedContacts && isArchived,
            isArchived
          });
          host.appendChild(node.firstChild);
        });

      host.querySelectorAll(".btn-edit").forEach(btn=>btn.addEventListener("click", async e=>{
        const id=e.currentTarget.getAttribute("data-id"); const c=await getByKey("contacts", id);
        populateContactForm(c, { origin: currentView });
        window.scrollTo({top:0, behavior:'smooth'});
      }));
      host.querySelectorAll(".btn-log-now").forEach(btn=>btn.addEventListener("click", async e=>{
        const id=e.currentTarget.getAttribute("data-id"); const c=await getByKey("contacts", id); await logVisitNow(c);
      }));
      host.querySelectorAll(".btn-archive").forEach(btn=>{
        btn.addEventListener("click", async e=>{
          const id=e.currentTarget.getAttribute("data-id");
          const c=await getByKey("contacts", id); if (!c) return;
          const ok = confirm("Are you sure you want to remove this contact? This will archive them (hide from lists).");
          if (!ok) return;
          c.active=false; await putItem("contacts", c);
          renderContactsList(); renderToday();
        });
      });
      host.querySelectorAll(".btn-unarchive").forEach(btn=>{
        btn.addEventListener("click", async e=>{
          const id=e.currentTarget.getAttribute("data-id");
          const c=await getByKey("contacts", id); if (!c) return;
          c.active=true; await putItem("contacts", c);
          renderContactsList(); renderToday();
        });
      });
    }

    async function renderVisits(){
      const q=$("#visit-search").value?.toLowerCase().trim()||"";
      const [contacts, visitsSnap] = await Promise.all([getAll("contacts"), db.collection(colPath("visits")).get()]);
      const visits = visitsSnap.docs.map(d=>Object.assign({id:d.id}, d.data()));
      const nameById = {}; contacts.forEach(c=> nameById[c.id]=c.name);
      const filtered = visits.filter(v=>{
        const hay=((nameById[v.contactId]||"")+" "+(v.notes||"")+" "+(v.nextSteps||"")+" "+(v.outcome||"")).toLowerCase();
        return !q || hay.includes(q);
      }).sort((a,b)=> new Date(b.visitDate) - new Date(a.visitDate));
      const host=$("#visit-list"); host.innerHTML="";
      filtered.forEach(v=>{
        const div=document.createElement("div"); div.innerHTML =
          '<div class="card">\
            <div class="row" style="justify-content:space-between">\
              <h3>'+ (nameById[v.contactId]||"Unknown contact") +'</h3>\
              <span class="muted">'+ fmtDate(v.visitDate) +'</span>\
            </div>\
            <div class="row" style="gap:10px">\
              <span class="pill">'+ (v.outcome||"") +'</span>\
              '+ (v.nextSteps?('<span class="pill">Next: '+v.nextSteps+'</span>'):'') +'\
              '+ (v.createdBy?('<span class="pill">By: '+v.createdBy+'</span>'):'') +'\
            </div>'+ (v.notes?('<div style="margin-top:6px">'+v.notes+'</div>'):'') +'\
          </div>';
        host.appendChild(div.firstChild);
      });
    }

    async function saveContactFromForm(e){
      e?.preventDefault?.();
      const existingId = ($("#contact-id").value||"").trim();
      const freq = $("#frequency").value;
      const existing = existingId ? await getByKey("contacts", existingId) : null;
      const record = existing ? Object.assign({}, existing) : {};
      record.name = $("#name").value.trim();
      record.org = $("#org").value.trim();
      record.location = $("#location").value.trim();
      record.frequency = freq;
      record.freqDays = Number($("#freqDays").value || (defaultDaysMap[freq]||30));
      record.lastVisit = $("#lastVisit").value ? new Date($("#lastVisit").value).toISOString() : null;
      record.active = $("#active").value === "true";
      if (!record.name){ alert("Name is required."); return; }
      if (existingId) { record.id = existingId; await putItem("contacts", record); $("#contact-id").value = existingId; }
      else { const newId = await addItem("contacts", record); $("#contact-id").value = newId; }
      await Promise.all([renderToday(), renderContactsList(), refreshVisitContactDropdown()]);
      hideContactForm();
      showSection("view-today");
    }

    async function logVisitNow(contact){
      if (!contact) return;
      const ok = confirm("Mark " + (contact.name || "this contact") + " as visited now?");
      if (!ok) return;
      const visit={ contactId: contact.id, visitDate: new Date().toISOString(), notes: "", outcome:"Follow-up", nextSteps:"", createdBy:"" };
      await addItem("visits", visit);
      contact.lastVisit = visit.visitDate; await putItem("contacts", contact);
      await Promise.all([renderToday(), renderVisits()]);
    }

    async function saveVisitFromForm(e){
      e?.preventDefault?.();
      const contactId = $("#visit-contact").value;
      if (!contactId){ alert("Pick a contact."); return; }
      const dt = $("#visit-date").value ? new Date($("#visit-date").value).toISOString() : new Date().toISOString();
      const visit={ contactId: contactId, visitDate: dt, notes: $("#visit-notes").value.trim(), outcome: $("#visit-outcome").value, nextSteps: $("#visit-next").value.trim(), createdBy: $("#visit-createdBy").value.trim() };
      await addItem("visits", visit);
      const c = await getByKey("contacts", contactId); c.lastVisit = dt; await putItem("contacts", c);
      $("#visit-form").reset(); await Promise.all([renderToday(), renderVisits()]);
    }
    async function refreshVisitContactDropdown(){
      const sel=$("#visit-contact");
      const contacts=(await getAll("contacts")).filter(c=>c.active!==false).sort((a,b)=> (a.name||"").localeCompare(b.name||""));
      sel.innerHTML='<option value="">— Select —</option>'+contacts.map(c=>'<option value="'+c.id+'">'+c.name+'</option>').join("");
    }

    async function exportJSON(){
      const [contactsSnap, visitsSnap] = await Promise.all([
        db.collection(colPath("contacts")).get(),
        db.collection(colPath("visits")).get()
      ]);
      const contacts = contactsSnap.docs.map(d=>Object.assign({id:d.id}, d.data()));
      const visits = visitsSnap.docs.map(d=>Object.assign({id:d.id}, d.data()));
      const blob = new Blob([JSON.stringify({ exportedAt: new Date().toISOString(), contacts, visits }, null, 2)], {type:"application/json"});
      const a = document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="visit-tracker-backup.json"; a.click(); URL.revokeObjectURL(a.href);
    }
    async function importJSON(file){
      const text=await file.text(); const data=JSON.parse(text);
      if(!data.contacts||!data.visits){ alert("Invalid file."); return; }
      if(!confirm("Importing will MERGE with existing records. Continue?")) return;
      const idMap={};
      for (const c of data.contacts){
        const copy=Object.assign({}, c);
        delete copy.id;
        const newId=await addItem("contacts", copy);
        if(c.id!==undefined&&c.id!==null) idMap[c.id]=newId;
      }
      for (const v of data.visits){
        const newId=idMap[v.contactId];
        if(newId){
          const copy2=Object.assign({}, v);
          delete copy2.id;
          copy2.contactId=newId;
          await addItem("visits", copy2);
        }
      }
      await Promise.all([renderToday(), renderContactsList(), renderVisits(), refreshVisitContactDropdown()]);
      alert("Import complete.");
    }
    async function importCSV(file){
      if (!user){ alert("Sign in first."); return; }
      const existing = await getAll("contacts");
      const byKey = {}; existing.forEach(c=>{ byKey[((c.name||"")+"|"+(c.org||"")).toLowerCase()]=true; });

      Papa.parse(file, {
        header: true,
        skipEmptyLines: true,
        complete: async (results)=>{
          const rows = results.data || [];
          if (!rows.length){ alert("No rows found."); return; }
          const get=(o,...keys)=>{ for (const k of keys){ if (o[k]!==undefined && o[k]!==null && String(o[k]).trim()!=="") return String(o[k]).trim(); } return ""; };
          const toAdd=[];
          for (const r of rows){
            const first=get(r,'First Name','FirstName','first_name','First');
            const last =get(r,'Last Name','LastName','last_name','Last');
            const name =get(r,'Name') || (first || last ? (first+" "+last).trim() : "");
            if (!name) continue;
            const org =get(r,'Account Name','Company','Organization','Account');
            const email=get(r,'Email','Work Email','Primary Email');
            const phone=get(r,'Phone','Work Phone','Mobile','Mobile Phone');
            const street=get(r,'Mailing Street','Street');
            const city  =get(r,'Mailing City','City');
            const state =get(r,'Mailing State/Province','Mailing State','State/Province','State');
            const zip   =get(r,'Mailing Postal Code','Postal Code','Zip');
            const country=get(r,'Mailing Country','Country');
            const location=[street,city,state,zip,country].filter(Boolean).join(', ');
            const lastVisitStr=get(r,'Last Activity Date','Last Visit','LastContact','Last Contact Date');
            const lastVisit= lastVisitStr ? new Date(lastVisitStr).toISOString() : null;
            const k=(name+'|'+(org||'')).toLowerCase();
            if (byKey[k]) continue;
            toAdd.push({ name, org, location, email, phone, frequency:'Monthly', freqDays:30, lastVisit, notes:'', active:true });
          }
          if (!toAdd.length){ alert("Everything already exists (Name+Org) or no valid rows."); return; }
          if (!confirm(`Import ${toAdd.length} contacts into your account? (Duplicates by Name+Org are skipped)`)) return;
          for (const c of toAdd){ await addItem("contacts", c); }
          await Promise.all([renderToday(), renderContactsList(), refreshVisitContactDropdown()]);
          alert("CSV import complete.");
        },
        error: (err)=> alert("CSV parse error: "+err.message)
      });
    }

    // ----- Views & wiring
    function showSection(id){
      ["view-today","view-contacts","view-log"].forEach(v=>document.getElementById(v).classList.add("hidden"));
      document.getElementById(id).classList.remove("hidden");
      currentView = id;
    }

    function attachClearableSearch(inputSel, buttonSel){
      const input = $(inputSel);
      const button = $(buttonSel);
      if (!input || !button) return;
      const toggle = ()=>{
        const hasValue = !!(input.value && input.value.length);
        button.classList.toggle("hidden", !hasValue);
      };
      input.addEventListener("input", toggle);
      input.addEventListener("search", toggle);
      button.addEventListener("click", ()=>{
        if (!input.value){ input.focus(); return; }
        input.value = "";
        input.dispatchEvent(new Event("input", { bubbles:true }));
        input.focus();
        toggle();
      });
      toggle();
    }

    function setupExpandableSearch(){
      const toolbar = document.querySelector("#view-today .toolbar");
      const input = $("#search");
      const clearBtn = $("#btn-clear-search");
      if (!toolbar || !input) return;
      const expand = ()=>{
        if (input.dataset.suppressExpand === "true"){ delete input.dataset.suppressExpand; return; }
        toolbar.classList.add("search-expanded");
      };
      const collapse = ()=>{ if (!(input.value||"").trim()) toolbar.classList.remove("search-expanded"); };
      input.addEventListener("focus", expand);
      input.addEventListener("blur", ()=> setTimeout(collapse, 80));
      input.addEventListener("input", ()=>{ if ((input.value||"").trim()) expand(); else collapse(); });
      clearBtn?.addEventListener("mousedown", ()=>{ input.dataset.suppressExpand = "true"; });
      clearBtn?.addEventListener("mouseleave", ()=>{ delete input.dataset.suppressExpand; });
      clearBtn?.addEventListener("click", ()=>{
        setTimeout(()=>{
          delete input.dataset.suppressExpand;
          collapse();
        }, 0);
      });
      if ((input.value||"").trim()) expand();
    }

    function wireEvents(){
      $("#btn-show-today").addEventListener("click", ()=>{ showSection("view-today"); renderToday(); });
      $("#btn-show-contacts").addEventListener("click", ()=>{ showSection("view-contacts"); renderContactsList(); });
      $("#btn-show-log").addEventListener("click", ()=>{ showSection("view-log"); renderVisits(); });

      $("#btn-show-contact-form").addEventListener("click", ()=>{
        const origin = currentView;
        showSection("view-contacts");
        showContactForm({ origin });
        clearContactForm();
        $("#name").focus();
      });

      $("#btn-add-quick").addEventListener("click", ()=>{
        const origin = currentView;
        showSection("view-contacts");
        showContactForm({ origin });
        clearContactForm();
        $("#name").focus();
        window.scrollTo({top:0, behavior:'smooth'});
      });

      $("#btn-export").addEventListener("click", exportJSON);
      $("#btn-import-json").addEventListener("click", ()=> $("#import-json-file").click());
      $("#import-json-file").addEventListener("change", (e)=>{ if(e.target.files[0]) importJSON(e.target.files[0]); });

      $("#btn-import-csv").addEventListener("click", ()=> $("#import-csv-file").click());
      $("#import-csv-file").addEventListener("change", (e)=>{ if(e.target.files[0]) importCSV(e.target.files[0]); });

      $("#contact-form").addEventListener("submit", saveContactFromForm);
      $("#btn-reset").addEventListener("click", clearContactForm);
      document.querySelectorAll(".btn-cancel-contact").forEach(btn=>{
        btn.addEventListener("click", ()=> hideContactForm({ restoreView:true }));
      });
      $("#frequency").addEventListener("change", ()=>{
        const f=$("#frequency").value;
        $("#freqDays").value = (defaultDaysMap[f]||Number($("#freqDays").value||30));
      });

      $("#visit-form").addEventListener("submit", saveVisitFromForm);
      $("#btn-quick-today").addEventListener("click", async ()=>{
        const id=$("#visit-contact").value; if(!id){ alert("Pick a contact."); return; }
        const c=await getByKey("contacts", id); await logVisitNow(c); $("#visit-form").reset();
      });

      // Today filters
      $("#search").addEventListener("input", renderToday);
      $("#search").addEventListener("search", renderToday);
      $("#filter-status").addEventListener("change", renderToday);

      // Contacts search: input, iOS 'search' clear, Enter key
      $("#contact-search").addEventListener("input", renderContactsList);
      $("#contact-search").addEventListener("search", renderContactsList);
      $("#contact-search").addEventListener("keydown", (e)=>{ if (e.key === "Enter"){ e.preventDefault(); renderContactsList(); } });
      $("#btn-toggle-archived").addEventListener("click", ()=>{
        showArchivedContacts = !showArchivedContacts;
        updateArchivedToggleUI();
        renderContactsList();
      });

      attachClearableSearch("#search", "#btn-clear-search");
      attachClearableSearch("#contact-search", "#btn-clear-contact-search");
      setupExpandableSearch();

      // Auth buttons + Enter key in either field (always active)
      const signin = async ()=>{
        const email=$("#auth-email").value.trim();
        const pass=$("#auth-pass").value;
        if(!email || !pass){ alert("Please enter email and password."); return; }
        try{
          $("#btn-signin").disabled=true; $("#btn-signin").textContent="Signing in…";
          await auth.signInWithEmailAndPassword(email, pass);
        }catch(e){ alert("Sign in failed: " + (e.message || e)); }
        finally{ $("#btn-signin").disabled=false; $("#btn-signin").textContent="Sign in"; }
      };
      $("#btn-signin").addEventListener("click", (e)=>{ e.preventDefault(); signin(); });
      $("#auth-email").addEventListener("keydown", (e)=>{ if(e.key==="Enter"){ e.preventDefault(); signin(); } });
      $("#auth-pass").addEventListener("keydown", (e)=>{ if(e.key==="Enter"){ e.preventDefault(); signin(); } });

      $("#btn-signup").addEventListener("click", async ()=>{
        const email=$("#auth-email").value.trim(); const pass=$("#auth-pass").value;
        try { await auth.createUserWithEmailAndPassword(email, pass); } catch (e) { alert("Create failed: "+(e.message||e)); }
      });
      $("#btn-signout").addEventListener("click", async ()=>{ await auth.signOut(); });
    }

    function updateAuthUI(){
      const una = $("#authbar-unauthed");
      const aut = $("#authbar-authed");
      if (user) { una.classList.add("hidden"); aut.classList.remove("hidden"); $("#whoami").textContent = user.email; }
      else { una.classList.remove("hidden"); aut.classList.add("hidden"); }
    }
    function clearUI(){
      $("#today-list").innerHTML="";
      $("#contact-list").innerHTML="";
      $("#visit-list").innerHTML="";
      hideContactForm();
    }

    let unsubscribeContacts = null;
    let unsubscribeVisits = null;

    function subscribeRealtime(){
      if (typeof unsubscribeContacts === "function") { unsubscribeContacts(); unsubscribeContacts = null; }
      if (typeof unsubscribeVisits === "function") { unsubscribeVisits(); unsubscribeVisits = null; }

      unsubscribeContacts = db.collection(colPath("contacts")).onSnapshot(()=>{
        renderToday();
        renderContactsList();
        refreshVisitContactDropdown();
      });
      unsubscribeVisits = db.collection(colPath("visits")).onSnapshot(()=>{ renderVisits(); });
    }

    // ----- Init
    (function init(){
      wireEvents();
      auth.onAuthStateChanged((u)=>{
        user=u||null; updateAuthUI();
        if(user){
          subscribeRealtime();
          loadAllAndRender();
        } else {
          if (typeof unsubscribeContacts === "function") { unsubscribeContacts(); unsubscribeContacts = null; }
          if (typeof unsubscribeVisits === "function") { unsubscribeVisits(); unsubscribeVisits = null; }
          clearUI();
        }
      });
    })();

    async function loadAllAndRender(){ await Promise.all([renderToday(), renderContactsList(), renderVisits(), refreshVisitContactDropdown()]); showSection("view-today"); }
  </script>

  <!-- Offline UI toggles -->
  <script>
    function updateOnlineUI(){
      const offline = !navigator.onLine;
      const banner = document.getElementById('offline-banner');
      if (banner) banner.style.display = offline ? 'block' : 'none';
      // Sign-in remains enabled; if actually offline, Firebase will just error and show the alert
    }
    window.addEventListener('online', updateOnlineUI);
    window.addEventListener('offline', updateOnlineUI);
    updateOnlineUI();
  </script>

  <!-- Friendly global error to surface issues quickly -->
  <script>
    window.addEventListener('unhandledrejection', (e)=>{ alert('Error (promise): ' + (e.reason && (e.reason.message || e.reason))); });
    window.addEventListener('error', (e)=>{ alert('Error (script): ' + e.message + (e.filename?(' @ '+e.filename+':'+e.lineno+':'+e.colno):'')); });
  </script>
</body>
</html>
