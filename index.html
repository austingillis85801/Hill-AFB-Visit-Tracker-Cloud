<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Hill AFB Visit Tracker (Cloud Sync) — v9</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="VisitTracker">
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <meta name="theme-color" content="#1f6feb">
  <style>
    :root { --bg:#f7f7fb; --card:#fff; --text:#222; --muted:#666; --border:#e5e5ef; --green:#26a269; --yellow:#e5a50a; --red:#c01c28; --blue:#1f6feb; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";background:var(--bg);color:var(--text)}

    /* Header — compact */
    header{position:sticky;top:0;z-index:5;background:linear-gradient(180deg,var(--blue),#3a7cf0);color:#fff;border-bottom:1px solid var(--border);padding:6px 10px;display:flex;flex-direction:column;gap:6px}
    .toprow{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    header h1{font-size:16px;margin:0}
    .tagline{color:#e6eeff;font-size:11px}
    @media (max-width: 520px){ .tagline{display:none} }
    .right{margin-left:auto}
    .row{display:flex;align-items:center;gap:6px;flex-wrap:wrap}
    .chip{background:transparent;color:#fff;border:1px solid rgba(255,255,255,.45);border-radius:999px;padding:5px 10px;font-size:14px}
    .chip.strong{background:#1f6feb;border-color:#1f6feb}
    .authbar input{border-color:rgba(255,255,255,.5);background:rgba(255,255,255,.1);color:#fff;border-radius:999px;padding:6px 10px;font-size:14px}
    .authbar input::placeholder{color:#eef}
    .whoami{font-size:12px;color:#e6eeff;margin-right:2px}
    @media (max-width:430px){ .whoami{display:none} }
    .hidden{display:none!important}

    .navchips{display:flex;gap:8px;flex-wrap:wrap}

    main{padding:14px;max-width:1100px;margin:0 auto}
    .toolbar{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:10px}

    button,select,input,textarea{font:inherit;padding:9px 12px;border-radius:10px;border:1px solid var(--border);background:#fff;color:#222}
    .field input,.field select,.field textarea{width:100%}
    label{display:block;margin:0 0 5px 2px;font-weight:600}

    .grid{display:grid;grid-template-columns:1fr;gap:10px}
    .col-4,.col-6,.col-8,.col-12{grid-column:span 1}
    @media (min-width: 900px){
      .grid{grid-template-columns:repeat(12,minmax(0,1fr))}
      .col-4{grid-column:span 4}.col-6{grid-column:span 6}.col-8{grid-column:span 8}.col-12{grid-column:span 12}
    }

    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:10px;box-shadow:0 1px 2px rgba(0,0,0,.03)}
    .card h3{margin:0 0 4px 0;font-size:16px}
    .muted{color:var(--muted);font-size:12px}

    .card.red{border-left:6px solid var(--red)}
    .card.yellow{border-left:6px solid var(--yellow)}
    .card.green{border-left:6px solid var(--green)}
    .contact-row{display:flex;gap:10px;align-items:flex-start;justify-content:space-between;flex-wrap:wrap}
    .contact-actions{display:flex;gap:6px;flex-wrap:wrap}
    .pill{font-size:11px;padding:2px 8px;border-radius:999px;border:1px solid var(--border);background:#fff;display:inline-block}
    .pill.red{border-color:var(--red);color:var(--red)} .pill.yellow{border-color:var(--yellow);color:var(--yellow)} .pill.green{border-color:var(--green);color:var(--green)}
    .meta-line{display:flex;gap:6px;align-items:center;flex-wrap:nowrap;overflow:auto;scrollbar-width:none}
    .meta-line::-webkit-scrollbar{display:none}

    .btn-ghost{background:#fff;border:1px solid var(--border);border-radius:999px;padding:7px 14px}

    #today-list,#visit-list,#contact-list{display:grid;grid-template-columns:1fr;gap:10px}
    @media (min-width:600px){ #today-list,#contact-list{grid-template-columns:1fr 1fr} }
    @media (min-width:1100px){ #today-list,#contact-list{grid-template-columns:1fr 1fr 1fr} }

    .footer{margin-top:16px;color:var(--muted);font-size:12px}
  </style>

  <!-- CSV parser for Import CSV -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>
  <header>
    <div class="toprow">
      <h1>Hill AFB Visit Tracker (Cloud Sync) — v9</h1>
      <span class="tagline">Cloud sync • Offline • Local cache</span>

      <!-- Signed OUT -->
      <div class="right row authbar" id="authbar-unauthed">
        <input id="auth-email" placeholder="email" autocapitalize="off">
        <input id="auth-pass" placeholder="password" type="password">
        <button id="btn-signin" class="chip">Sign in</button>
        <button id="btn-signup" class="chip">Create</button>
      </div>

      <!-- Signed IN -->
      <div class="right row authbar hidden" id="authbar-authed">
        <span id="whoami" class="whoami"></span>
        <button id="btn-export" class="chip">Export</button>
        <button id="btn-import-json" class="chip">Import JSON</button>
        <button id="btn-import-csv" class="chip">Import CSV</button>
        <input id="import-json-file" type="file" accept="application/json" class="hidden">
        <input id="import-csv-file" type="file" accept=".csv,text/csv" class="hidden">
        <button id="btn-signout" class="chip strong">Sign out</button>
      </div>
    </div>

    <div class="navchips" id="nav-controls">
      <button id="btn-show-today" class="chip">Today</button>
      <button id="btn-show-contacts" class="chip">Contacts</button>
      <button id="btn-show-log" class="chip">Log Visit</button>
    </div>
  </header>

  <main>
    <section id="view-today">
      <div class="toolbar">
        <input id="search" placeholder="Search name/org/location…" style="flex:1">
        <select id="filter-status">
          <option value="all">All statuses</option>
          <option value="red">Past due</option>
          <option value="yellow">Due this week</option>
          <option value="green">Not due</option>
        </select>
        <button id="btn-add-quick" class="chip strong">+ Quick add</button>
      </div>
      <div id="today-list"></div>
      <div class="footer">Status rules: <span class="pill red">Past due</span> ≤ today • <span class="pill yellow">Due this week</span> within 7 days • <span class="pill green">Not due</span> &gt; 7 days.</div>
    </section>

    <section id="view-contacts" class="hidden">
      <div class="grid">
        <div class="col-6 card">
          <h3 id="form-title">Add Contact</h3>
          <form id="contact-form">
            <input type="hidden" id="contact-id">
            <div class="grid">
              <div class="col-6 field"><label>Name</label><input id="name" required></div>
              <div class="col-6 field"><label>Org</label><input id="org"></div>
              <div class="col-12 field"><label>Location</label><input id="location"></div>
              <div class="col-6 field"><label>Email</label><input id="email" type="email"></div>
              <div class="col-6 field"><label>Phone</label><input id="phone"></div>
              <div class="col-6 field"><label>Frequency</label>
                <select id="frequency">
                  <option>Weekly</option><option>Biweekly</option><option selected>Monthly</option><option>Quarterly</option><option>Custom</option>
                </select>
              </div>
              <div class="col-6 field"><label>Frequency (days)</label><input id="freqDays" type="number" min="1" value="30"></div>
              <div class="col-6 field"><label>Last Visit</label><input id="lastVisit" type="date"></div>
              <div class="col-6 field"><label>Active</label>
                <select id="active"><option value="true" selected>Yes</option><option value="false">No</option></select>
              </div>
              <div class="col-12 field"><label>Notes</label><textarea id="notes" rows="3"></textarea></div>
              <div class="col-12 row" style="justify-content:flex-start">
                <button class="chip strong" type="submit" id="btn-save-contact">Save</button>
                <button type="button" id="btn-reset" class="chip">Reset</button>
                <span class="muted" style="margin-left:auto">Tip: set Frequency to Custom for exact days.</span>
              </div>
            </div>
          </form>
        </div>
        <div class="col-6">
          <div class="toolbar"><input id="contact-search" placeholder="Search contacts…" style="flex:1"></div>
          <div id="contact-list"></div>
        </div>
      </div>
    </section>

    <section id="view-log" class="hidden">
      <div class="grid">
        <div class="col-4 card">
          <h3>Log Visit</h3>
          <form id="visit-form">
            <div class="field"><label>Contact</label><select id="visit-contact" required></select></div>
            <div class="grid">
              <div class="col-6 field"><label>Visit Date</label><input id="visit-date" type="datetime-local"></div>
              <div class="col-6 field"><label>Outcome</label>
                <select id="visit-outcome">
                  <option>Discovery</option><option>Follow-up</option><option>Quote Sent</option>
                  <option>Closed Won</option><option>Closed Lost</option><option>Other</option>
                </select>
              </div>
              <div class="col-12 field"><label>Notes</label><textarea id="visit-notes" rows="4"></textarea></div>
              <div class="col-12 field"><label>Next Steps</label><input id="visit-next"></div>
              <div class="col-12 field"><label>Created By</label><input id="visit-createdBy" placeholder="GAR name or email"></div>
            </div>
            <div class="row" style="margin-top:8px">
              <button class="chip strong" type="submit">Save Visit</button>
              <button type="button" id="btn-quick-today" class="chip">Mark as seen now</button>
            </div>
          </form>
        </div>
        <div class="col-8">
          <div class="toolbar"><input id="visit-search" placeholder="Search visits…" style="flex:1"></div>
          <div id="visit-list"></div>
        </div>
      </div>
    </section>

    <div class="footer">
      Sign in (top-right) to enable sync across devices. Works offline; changes sync when back online. Export/Import still available for manual backup.
    </div>
  </main>

  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function() {
        navigator.serviceWorker.register('sw.js?v=9'); // bump to fetch latest
      });
    }
  </script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, enableIndexedDbPersistence, collection, addDoc, setDoc, doc, getDocs, getDoc, query, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAoVOV9GPu6n4M2BVFlOSnXwEUcASjL9Dk",
      authDomain: "hill-afb-tracker-cloud.firebaseapp.com",
      projectId: "hill-afb-tracker-cloud",
      storageBucket: "hill-afb-tracker-cloud.firebasestorage.app",
      messagingSenderId: "554533323322",
      appId: "1:554533323322:web:ba751bda081e9d5d006b03"
    };

    const $ = (sel) => document.querySelector(sel);
    var app, auth, db, user = null;

    function validConfig(cfg) { return !!(cfg && cfg.apiKey); }
    function colPath(store) { return "users/" + (user ? user.uid : "NOUSER") + "/" + store; }

    async function addItem(store, value) {
      if (!user) throw new Error("Sign in first");
      const ref = await addDoc(collection(db, colPath(store)), value);
      await setDoc(ref, Object.assign({}, value, { id: ref.id }), { merge: true });
      return ref.id;
    }
    async function putItem(store, value) {
      if (!user) throw new Error("Sign in first");
      const id = value.id || (await addItem(store, value));
      if (!value.id) return id;
      const ref = doc(db, colPath(store), id);
      await setDoc(ref, value, { merge: true });
      return id;
    }
    async function getAll(store) {
      if (!user) return [];
      const snap = await getDocs(query(collection(db, colPath(store))));
      return snap.docs.map(d => { const v=d.data(); v.id=d.id; return v; });
    }
    async function getByKey(store, id) {
      const ref = doc(db, colPath(store), id);
      const snap = await getDoc(ref);
      return snap.exists() ? (function(){ const v=snap.data(); v.id=snap.id; return v; })() : null;
    }

    function fmtDate(date){ if(!date) return ""; const d=new Date(date); return d.toLocaleDateString()+" "+d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}); }
    function fmtDateOnly(date){ if(!date) return ""; const d=new Date(date); return d.toISOString().slice(0,10); }
    function dateAddDays(date, days){ const d=new Date(date||new Date()); d.setHours(0,0,0,0); d.setDate(d.getDate()+Number(days||0)); return d; }
    function defaultDays(freq, fallback){ if(fallback===undefined) fallback=30; if(freq==="Weekly") return 7; if(freq==="Biweekly") return 14; if(freq==="Monthly") return 30; if(freq==="Quarterly") return 90; return fallback; }
    function computeStatus(contact){
      const last = contact.lastVisit ? new Date(contact.lastVisit) : null;
      const days = contact.freqDays || defaultDays(contact.frequency, 30);
      const nextDue = last ? dateAddDays(last, days) : new Date();
      const today = new Date(); today.setHours(0,0,0,0);
      const diff = Math.floor((nextDue - today)/(1000*60*60*24));
      var status = "red"; if(last){ status = diff<=0 ? "red" : (diff<=7 ? "yellow" : "green"); }
      return { nextDue: nextDue, diffDays: diff, status: status };
    }

    function contactCardHTML(c, opts){
      opts = opts || {};
      const showArchive = !!opts.showArchive;
      return '<div class="card '+c.status+'">\
        <div class="contact-row">\
          <div style="flex:1 1 auto;min-width:220px">\
            <h3>'+ (c.name||"") +'</h3>\
            <div class="muted">'+ ((c.org||"") + (c.org&&c.location?" • ":"") + (c.location||"")) +'</div>\
            <div class="meta-line" style="margin-top:6px">\
              <span class="pill '+c.status+'">'+(c.status==="red"?"Past due":(c.status==="yellow"?"Due this week":"Not due"))+'</span>\
              <span class="pill">Due: '+ fmtDateOnly(c.nextDue) +'</span>\
              <span class="pill">Freq: '+ (c.frequency||"") + (c.frequency==="Custom"?" ("+c.freqDays+"d)":"") +'</span>\
            </div>\
          </div>\
          <div class="contact-actions">\
            <button data-id="'+c.id+'" class="btn-ghost btn-log-now">Log</button>\
            <button data-id="'+c.id+'" class="btn-ghost btn-edit">Edit</button>' +
            (showArchive ? ' <button data-id="'+c.id+'" class="btn-ghost btn-archive">Archive</button>' : '') +
          '</div>\
        </div>\
      </div>';
    }

    async function renderToday(){
      const q = ($("#search").value||"").toLowerCase().trim();
      const statusFilter = $("#filter-status").value;
      const contacts = (await getAll("contacts")).filter(function(c){ return c.active !== false; });
      const enriched = contacts.map(function(c){ const e=computeStatus(c); const o={}; for (var k in c) o[k]=c[k]; for (var k2 in e) o[k2]=e[k2]; return o; })
        .filter(function(c){
          const hay=(c.name+" "+(c.org||"")+" "+(c.location||"")).toLowerCase();
          return (!q || hay.includes(q)) && (statusFilter==="all" || c.status===statusFilter);
        })
        .sort(function(a,b){
          function score(s){ return s==="red"?3:s==="yellow"?2:1; }
          const s = score(b.status)-score(a.status); if(s!==0) return s;
          const d = a.diffDays - b.diffDays; if(d!==0) return d;
          return (a.name||"").localeCompare(b.name||"");
        });

      const host=$("#today-list"); host.innerHTML="";
      enriched.forEach(function(c){
        const wrap=document.createElement("div");
        wrap.innerHTML = contactCardHTML(c, {showArchive:false}); // Today: no Archive
        host.appendChild(wrap.firstChild);
      });

      host.querySelectorAll(".btn-edit").forEach(function(btn){ btn.addEventListener("click", async function(e){ const id=e.currentTarget.getAttribute("data-id"); const c=await getByKey("contacts", id); showSection("view-contacts"); populateContactForm(c); });});
      host.querySelectorAll(".btn-log-now").forEach(function(btn){ btn.addEventListener("click", async function(e){ const id=e.currentTarget.getAttribute("data-id"); const c=await getByKey("contacts", id); await logVisitNow(c); });});
    }

    function populateContactForm(c){
      document.getElementById("form-title").textContent = (c && c.id) ? "Edit Contact" : "Add Contact";
      document.getElementById("contact-id").value = (c && c.id) ? c.id : "";
      document.getElementById("name").value = (c && c.name) ? c.name : "";
      document.getElementById("org").value = (c && c.org) ? c.org : "";
      document.getElementById("location").value = (c && c.location) ? c.location : "";
      document.getElementById("email").value = (c && c.email) ? c.email : "";
      document.getElementById("phone").value = (c && c.phone) ? c.phone : "";
      document.getElementById("frequency").value = (c && c.frequency) ? c.frequency : "Monthly";
      document.getElementById("freqDays").value = (c && c.freqDays) ? c.freqDays : ({"Weekly":7,"Biweekly":14,"Monthly":30,"Quarterly":90}[document.getElementById("frequency").value]||30);
      document.getElementById("lastVisit").value = (c && c.lastVisit) ? fmtDateOnly(c.lastVisit) : "";
      document.getElementById("active").value = (c && c.active===false) ? "false" : "true";
      document.getElementById("notes").value = (c && c.notes) ? c.notes : "";
    }

    async function renderContactsList(){
      const q = (document.getElementById("contact-search").value||"").toLowerCase().trim();
      const contacts = (await getAll("contacts")).filter(function(c){ return c.active!==false; })
        .sort(function(a,b){ return (a.name||"").localeCompare(b.name||""); });
      const host = document.getElementById("contact-list"); host.innerHTML="";
      contacts.filter(function(c){
        const hay=(c.name+" "+(c.org||"")+" "+(c.location||"")).toLowerCase();
        return !q || hay.includes(q);
      }).forEach(function(c){
        const cmp=computeStatus(c);
        const node=document.createElement("div");
        node.innerHTML=contactCardHTML(Object.assign({}, c, cmp), {showArchive:true});
        host.appendChild(node.firstChild);
      });

      host.querySelectorAll(".btn-edit").forEach(function(btn){ btn.addEventListener("click", async function(e){ const id=e.currentTarget.getAttribute("data-id"); const c=await getByKey("contacts", id); populateContactForm(c); });});
      host.querySelectorAll(".btn-log-now").forEach(function(btn){ btn.addEventListener("click", async function(e){ const id=e.currentTarget.getAttribute("data-id"); const c=await getByKey("contacts", id); await logVisitNow(c); });});
      host.querySelectorAll(".btn-archive").forEach(function(btn){
        btn.addEventListener("click", async function(e){
          const id=e.currentTarget.getAttribute("data-id");
          const c=await getByKey("contacts", id);
          if (!c) return;
          const ok = confirm("Are you sure you want to remove this contact? This will archive them (hide from lists).");
          if (!ok) return;
          c.active=false;
          await putItem("contacts", c);
          renderContactsList();
          renderToday();
        });
      });
    }

    async function renderVisits(){
      const q=(document.getElementById("visit-search").value||"").toLowerCase().trim();
      const results = await Promise.all([getAll("contacts"), getAll("visits")]);
      const contacts = results[0], visits = results[1];
      const nameById = {}; contacts.forEach(function(c){ nameById[c.id]=c.name; });
      const filtered = visits.filter(function(v){
        const hay=( (nameById[v.contactId]||"") +" "+(v.notes||"")+" "+(v.nextSteps||"")+" "+(v.outcome||"") ).toLowerCase();
        return !q || hay.includes(q);
      }).sort(function(a,b){ return new Date(b.visitDate) - new Date(a.visitDate); });
      const host=document.getElementById("visit-list"); host.innerHTML="";
      filtered.forEach(function(v){
        const div=document.createElement("div"); div.innerHTML =
          '<div class="card">\
            <div class="row" style="justify-content:space-between">\
              <h3>'+ (nameById[v.contactId]||"Unknown contact") +'</h3>\
              <span class="muted">'+ fmtDate(v.visitDate) +'</span>\
            </div>\
            <div class="row" style="gap:10px">\
              <span class="pill">'+ (v.outcome||"") +'</span>\
              '+ (v.nextSteps?('<span class="pill">Next: '+v.nextSteps+'</span>'):'') +'\
              '+ (v.createdBy?('<span class="pill">By: '+v.createdBy+'</span>'):'') +'\
            </div>'+ (v.notes?('<div style="margin-top:6px">'+v.notes+'</div>'):'') +'\
          </div>';
        host.appendChild(div.firstChild);
      });
    }

    async function saveContactFromForm(e){
      if (e && e.preventDefault) e.preventDefault();
      const existingId = (document.getElementById("contact-id").value||"").trim();
      const freq = document.getElementById("frequency").value;
      const record = {
        name: document.getElementById("name").value.trim(),
        org: document.getElementById("org").value.trim(),
        location: document.getElementById("location").value.trim(),
        email: document.getElementById("email").value.trim(),
        phone: document.getElementById("phone").value.trim(),
        frequency: freq,
        freqDays: Number(document.getElementById("freqDays").value || ({"Weekly":7,"Biweekly":14,"Monthly":30,"Quarterly":90}[freq]||30)),
        lastVisit: document.getElementById("lastVisit").value ? new Date(document.getElementById("lastVisit").value).toISOString() : null,
        notes: document.getElementById("notes").value.trim(),
        active: document.getElementById("active").value === "true"
      };
      if (!record.name){ alert("Name is required."); return; }
      if (existingId) { record.id = existingId; await putItem("contacts", record); document.getElementById("contact-id").value = existingId; }
      else { const newId = await addItem("contacts", record); document.getElementById("contact-id").value = newId; }
      await Promise.all([renderToday(), renderContactsList(), refreshVisitContactDropdown()]);
      showSection("view-today");
    }

    async function logVisitNow(contact){
      const notes = prompt("Notes for " + (contact && contact.name ? contact.name : "contact") + "?", "");
      const visit={ contactId: contact.id, visitDate: new Date().toISOString(), notes: notes||"", outcome:"Follow-up", nextSteps:"", createdBy:"" };
      await addItem("visits", visit);
      contact.lastVisit = visit.visitDate; await putItem("contacts", contact);
      await Promise.all([renderToday(), renderVisits()]);
    }
    async function saveVisitFromForm(e){
      if (e && e.preventDefault) e.preventDefault();
      const contactId = document.getElementById("visit-contact").value;
      if (!contactId){ alert("Pick a contact."); return; }
      const dt = document.getElementById("visit-date").value ? new Date(document.getElementById("visit-date").value).toISOString() : new Date().toISOString();
      const visit={ contactId: contactId, visitDate: dt, notes: document.getElementById("visit-notes").value.trim(), outcome: document.getElementById("visit-outcome").value, nextSteps: document.getElementById("visit-next").value.trim(), createdBy: document.getElementById("visit-createdBy").value.trim() };
      await addItem("visits", visit);
      const c = await getByKey("contacts", contactId); c.lastVisit = dt; await putItem("contacts", c);
      document.getElementById("visit-form").reset(); await Promise.all([renderToday(), renderVisits()]);
    }
    async function refreshVisitContactDropdown(){
      const sel=document.getElementById("visit-contact");
      const contacts=(await getAll("contacts")).filter(function(c){ return c.active!==false; })
        .sort(function(a,b){ return (a.name||"").localeCompare(b.name||""); });
      sel.innerHTML='<option value="">— Select —</option>' + contacts.map(function(c){ return '<option value="'+c.id+'">'+c.name+'</option>'; }).join("");
    }

    function showSection(id){
      ["view-today","view-contacts","view-log"].forEach(function(v){ document.getElementById(v).classList.add("hidden"); });
      document.getElementById(id).classList.remove("hidden");
    }

    // JSON + CSV import/export wiring
    async function exportJSON(){
      const results = await Promise.all([getAll("contacts"), getAll("visits")]);
      const contacts = results[0], visits = results[1];
      const blob = new Blob([JSON.stringify({ exportedAt: new Date().toISOString(), contacts: contacts, visits: visits }, null, 2)], {type:"application/json"});
      const a = document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="visit-tracker-backup.json"; a.click(); URL.revokeObjectURL(a.href);
    }
    async function importJSON(file){
      const text=await file.text(); const data=JSON.parse(text); if(!data.contacts||!data.visits){ alert("Invalid file."); return; }
      if(!confirm("Importing will MERGE with existing records. Continue?")) return;
      for(var i=0;i<data.contacts.length;i++){ const c=data.contacts[i]; const copy=Object.assign({}, c); delete copy.id; await addItem("contacts", copy); }
      const all=await getAll("contacts"); const byName={}; all.forEach(function(c){ byName[c.name]=c.id; });
      for(var j=0;j<data.visits.length;j++){ const v=data.visits[j]; const name=(data.contacts.find(function(c){ return c.id===v.contactId; })||{}).name; const newId=name?byName[name]:null; if(newId){ const copy2=Object.assign({}, v); delete copy2.id; copy2.contactId=newId; await addItem("visits", copy2); } }
      await Promise.all([renderToday(), renderContactsList(), renderVisits(), refreshVisitContactDropdown()]); alert("Import complete.");
    }
    async function importCSV(file){
      if (!user){ alert("Sign in first."); return; }
      const existing = await getAll("contacts");
      const byKey = {}; existing.forEach(function(c){ const k=((c.name||"")+"|"+(c.org||"")).toLowerCase(); byKey[k]=true; });

      Papa.parse(file, {
        header: true,
        skipEmptyLines: true,
        complete: async function(results){
          const rows = results.data || [];
          if (!rows.length){ alert("No rows found."); return; }

          function get(o){ for (var i=1;i<arguments.length;i++){ var k=arguments[i]; if (o[k]!==undefined && o[k]!==null && String(o[k]).trim()!=="") return String(o[k]).trim(); } return ""; }

          const toAdd = [];
          for (var i=0;i<rows.length;i++){
            const r = rows[i];

            const first = get(r,'First Name','FirstName','first_name','First');
            const last  = get(r,'Last Name','LastName','last_name','Last');
            const name  = get(r,'Name') || (first || last ? (first+" "+last).trim() : "");
            if (!name) continue;

            const org = get(r,'Account Name','Company','Organization','Account');
            const email = get(r,'Email','Work Email','Primary Email');
            const phone = get(r,'Phone','Work Phone','Mobile','Mobile Phone');
            const street = get(r,'Mailing Street','Street');
            const city   = get(r,'Mailing City','City');
            const state  = get(r,'Mailing State/Province','Mailing State','State/Province','State');
            const zip    = get(r,'Mailing Postal Code','Postal Code','Zip');
            const country= get(r,'Mailing Country','Country');
            const location = [street, city, state, zip, country].filter(Boolean).join(', ');

            const lastVisitStr = get(r,'Last Activity Date','Last Visit','LastContact','Last Contact Date');
            const lastVisit = lastVisitStr ? new Date(lastVisitStr).toISOString() : null;

            const k = (name+'|'+(org||'')).toLowerCase();
            if (byKey[k]) continue; // skip duplicate (same Name+Org)

            toAdd.push({
              name: name,
              org: org,
              location: location,
              email: email,
              phone: phone,
              frequency: 'Monthly',
              freqDays: 30,
              lastVisit: lastVisit,
              notes: '',
              active: true
            });
          }

          if (!toAdd.length){ alert("Everything in that file already exists (by Name + Org) or no valid rows found."); return; }

          if (!confirm("Import "+toAdd.length+" contacts into your account? (Duplicates by Name+Org are skipped)")) return;

          for (var j=0;j<toAdd.length;j++){ await addItem("contacts", toAdd[j]); }
          await Promise.all([renderToday(), renderContactsList(), refreshVisitContactDropdown()]);
          alert("CSV import complete.");
        },
        error: function(err){ alert("CSV parse error: "+err.message); }
      });
    }

    function showSection(id){
      ["view-today","view-contacts","view-log"].forEach(function(v){ document.getElementById(v).classList.add("hidden"); });
      document.getElementById(id).classList.remove("hidden");
    }
    function wireEvents(){
      document.getElementById("btn-show-today").addEventListener("click", function(){ showSection("view-today"); renderToday(); });
      document.getElementById("btn-show-contacts").addEventListener("click", function(){ showSection("view-contacts"); renderContactsList(); });
      document.getElementById("btn-show-log").addEventListener("click", function(){ showSection("view-log"); renderVisits(); });
      document.getElementById("btn-add-quick").addEventListener("click", function(){ showSection("view-contacts"); document.getElementById("name").focus(); });

      document.getElementById("btn-export").addEventListener("click", exportJSON);
      document.getElementById("btn-import-json").addEventListener("click", function(){ document.getElementById("import-json-file").click(); });
      document.getElementById("import-json-file").addEventListener("change", function(e){ if(e.target.files[0]) importJSON(e.target.files[0]); });

      document.getElementById("btn-import-csv").addEventListener("click", function(){ document.getElementById("import-csv-file").click(); });
      document.getElementById("import-csv-file").addEventListener("change", function(e){ if(e.target.files[0]) importCSV(e.target.files[0]); });

      document.getElementById("contact-form").addEventListener("submit", saveContactFromForm);
      document.getElementById("btn-reset").addEventListener("click", function(){ document.getElementById("contact-form").reset(); document.getElementById("form-title").textContent="Add Contact"; });
      document.getElementById("frequency").addEventListener("change", function(){ var f=document.getElementById("frequency").value; document.getElementById("freqDays").value = ({"Weekly":7,"Biweekly":14,"Monthly":30,"Quarterly":90}[f]||Number(document.getElementById("freqDays").value||30)); });
      document.getElementById("visit-form").addEventListener("submit", saveVisitFromForm);
      document.getElementById("btn-quick-today").addEventListener("click", async function(){ const id=document.getElementById("visit-contact").value; if(!id){ alert("Pick a contact."); return; } const c=await getByKey("contacts", id); await logVisitNow(c); document.getElementById("visit-form").reset(); });

      document.getElementById("search").addEventListener("input", renderToday);
      document.getElementById("filter-status").addEventListener("change", renderToday);

      document.getElementById("btn-signin").addEventListener("click", async function(){ const email=document.getElementById("auth-email").value.trim(); const pass=document.getElementById("auth-pass").value; try { await signInWithEmailAndPassword(auth, email, pass); } catch (e) { alert("Sign in failed. If you don't have an account, tap Create."); } });
      document.getElementById("btn-signup").addEventListener("click", async function(){ const email=document.getElementById("auth-email").value.trim(); const pass=document.getElementById("auth-pass").value; try { await createUserWithEmailAndPassword(auth, email, pass); } catch (e) { alert("Create failed: "+e.message); } });
      document.getElementById("btn-signout").addEventListener("click", async function(){ await signOut(auth); });
    }
    function updateAuthUI(){
      const una = document.getElementById("authbar-unauthed");
      const aut = document.getElementById("authbar-authed");
      if (user) { una.classList.add("hidden"); aut.classList.remove("hidden"); document.getElementById("whoami").textContent = user.email; }
      else { una.classList.remove("hidden"); aut.classList.add("hidden"); }
    }
    function clearUI(){ document.getElementById("today-list").innerHTML=""; document.getElementById("contact-list").innerHTML=""; document.getElementById("visit-list").innerHTML=""; }
    function subscribeRealtime(){
      onSnapshot(collection(db, colPath("contacts")), function(){ renderToday(); renderContactsList(); refreshVisitContactDropdown(); });
      onSnapshot(collection(db, colPath("visits")), function(){ renderVisits(); });
    }

    (async function init(){
      if (!validConfig(firebaseConfig)) return;
      app = initializeApp(firebaseConfig); auth = getAuth(app); db = getFirestore(app);
      try { await enableIndexedDbPersistence(db); } catch (e) {}
      wireEvents();
      onAuthStateChanged(auth, function(u){ user=u||null; updateAuthUI(); if(user){ subscribeRealtime(); loadAllAndRender(); } else { clearUI(); } });
    })();

    async function loadAllAndRender(){ await Promise.all([renderToday(), renderContactsList(), renderVisits(), refreshVisitContactDropdown()]); showSection("view-today"); }
  </script>

  <script>
    window.addEventListener('unhandledrejection', function(e){ alert('Error (promise): ' + (e.reason && (e.reason.stack || e.reason.message || e.reason))); });
    window.addEventListener('error', function(e){ alert('Error (script): ' + e.message + (e.filename?(' @ '+e.filename+':'+e.lineno+':'+e.colno):'')); });
  </script>
</body>
</html>